name: Notify Discord on Merge to Integration

on:
  push:
    branches:
      - main

permissions:
  contents: read
  pull-requests: read
  id-token: write

jobs:
  notify:
    runs-on: ubuntu-latest

    steps:
      - name: Send Discord Notification
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        run: |
          ACTOR="${{ github.event.pusher.name }}"
          PUSH_TITLE="${{ github.event.commits.message }}"

          ESCAPED_PUSH_TITLE=$(echo "$PUSH_TITLE" | sed 's/"/\\"/g')

          echo "{\"content\": \"âœ… ## Attention \n\nPush to the repo \`main\`has been made by \`${ACTOR}\`.\n\n:envelope:Message Commits : ${ESCAPED_PUSH_TITLE}\"}" > payload.json

          cat payload.json

          curl -X POST "$DISCORD_WEBHOOK" \
               -H "Content-Type: application/json" \
               -d @payload.json